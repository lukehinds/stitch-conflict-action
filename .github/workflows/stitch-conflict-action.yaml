name: Fix Merge Conflicts with AI

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  fix-merge:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@fix-merge')
    runs-on: ubuntu-latest

    steps:
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone and set up remotes
        run: |
          git clone https://github.com/${{ github.repository }} repo
          cd repo

          # Setup remotes
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

          # Fetch both base and head branches
          git fetch origin +refs/heads/${{ github.event.issue.pull_request.base.ref }}:base-branch
          git fetch origin +refs/heads/${{ github.event.issue.pull_request.head.ref }}:pr-branch
        working-directory: ${{ github.workspace }}

      - name: Check out base branch
        run: |
          cd repo
          git checkout base-branch
        working-directory: ${{ github.workspace }}

      - name: Attempt merge
        run: |
          cd repo
          git merge pr-branch || echo "::warning ::Merge conflicts detected"
        working-directory: ${{ github.workspace }}

      - name: Find conflict files
        id: conflict_files
        run: |
          cd repo
          conflicts=$(git diff --name-only --diff-filter=U || true)
          echo "conflict_files=$conflicts" >> $GITHUB_OUTPUT
        working-directory: ${{ github.workspace }}

      - name: Simulate AI resolution
        if: steps.conflict_files.outputs.conflict_files != ''
        run: |
          cd repo
          echo "Resolving conflicts for:"
          echo "${{ steps.conflict_files.outputs.conflict_files }}"

          for file in ${{ steps.conflict_files.outputs.conflict_files }}; do
            sed -i '/^<<<<<<< /d;/^=======$/d;/^>>>>>>> /d' "$file"
          done

          git add .
          git commit -m "Auto-resolved merge conflicts via @fix-merge"
          git push origin HEAD:pr-branch
        working-directory: ${{ github.workspace }}

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            âœ… Merge conflicts were automatically resolved and pushed to the PR branch!
